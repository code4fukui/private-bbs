<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="icon" href="data:">
<title>BBS</title>
<link rel="stylesheet" href="style.css">
</head><body>

<header><h1 id="title">BBS</h1>
<div>
  <input type="text" id="in_name" placeholder="名前">
  <select id="sellang">
    <option value=ja>🇯🇵</option>
    <option value=mn>🇲🇳</option>
    <option value=en>🇺🇸</option>
  </select>
</div>
</header>

<div class="container" id="div_container">
  <div class="post-form">
    <h2 class="text">新規投稿</h2>
    <textarea id="ta_body" class="text" placeholder="本文をどうぞ！" rows="3" required></textarea>
    <button id="btn_post" class="text">投稿する</button>
  </div>

  <div id=posts>
    <!--
  <div class="post">
    <img src="https://via.placeholder.com/600x400" alt="投稿画像">

    <div class="post-content">
      <p><strong>@user1</strong> おいしいランチ！🍱<br>
      おいしいランチ！🍱<br>
      おいしいランチ！🍱<br>
      </p>
    </div>
    <div class="comments">
      <div class="comment"><strong>@commenter</strong> 美味しそう！</div>
      <div class="add-comment">
        <input type="text" placeholder="コメントを書く..."><button>投稿</button>
      </div>
    </div>
  </div>
  -->
  </div>
</div>

<!--
<button id="btn_sync">更新</button>
-->

<footer>
<div><a href=https://github.com/code4fukui/private-bbs/>src on GitHub</a></div>
</footer>


<script type="module">
import { TAI64N } from "https://code4fukui.github.io/TAI64N-es/TAI64N.js";
import { Post } from "./Post.js";
import { PubkeyUser, Coder } from "https://code4fukui.github.io/PubkeyUser/PubkeyUser.js";
import { DateTime } from "https://js.sabae.cc/DateTime.js";
import { showToast } from "./showToast.js";
import { detectLanguage } from "./detectLanguage.js";
import { changeLanguage, translate } from "./changeLanguage.js";
import { getLanguage } from "https://code4fukui.github.io/i18n/getLanguage.js"; // query lang

const settings = await (await fetch("./settings.json")).json();
document.title = title.textContent = settings.title;

const u = new PubkeyUser();

let data = [];

let lastdt = null;

const show = async () => {
  posts.innerHTML = "";

  const res = await u.fetch("getLatest", lastdt);
  for (const item of res) {
    if (!lastdt) {
      lastdt = item.data.id;
    } else {
      if (item.data.id.localeCompare(lastdt) > 0) {
        lastdt = item.data.id;
      }
    }
  }
  res.forEach(i => data.unshift(i));

  const list = data.filter(i => !i.data.parent);
  const latest = (item) => {
    let max = item.data.id;
    const chs = data.filter(i => i.data.parent == item.data.id);
    for (const ch of chs) {
      if (max.localeCompare(ch.data.id) < 0) {
        max = ch.data.id;
      }
    }
    return max;
  };
  for (const item of list) {
    item.latest = latest(item);
  }
  list.sort((a, b) => b.latest.localeCompare(a.latest));
  for (const item of list) {
    const div = makePost(item);
    posts.appendChild(div);
  }
};

in_name.value = localStorage.getItem("name") || "";

const sendPost = async (body, parent = null) => {
  const name = in_name.value;
  if (!name) {
    alert(translate("名前をご記入ください"));
    return;
  }
  localStorage.setItem("name", name);

  const lang = detectLanguage(body);

  const id = TAI64N.stringify(TAI64N.encode(new Date()));
  const data = {
    id,
    parent,
    pubkey: u.pubkey,
    name,
    body,
    lang,
    tags: [],
  };
  const post = Post.create(data, Coder.decode(u.prikey));
  try {
    const res = await u.fetch("add", post);
    return res;
  } catch (e) {
    console.log(e);
    alert(translate("通信エラーです。通信状況を確認して再度お試しください"));
    return null;
  }
};

const getComments = (post) => {
  const com = data.filter(i => post.data.id == i.data.parent);
  com.sort((a, b) => a.data.id.localeCompare(b.data.id));
  return com;
};

const time = (tai64n) => {
  const dt = new DateTime(TAI64N.toDate(TAI64N.parse(tai64n)));
  const now = new DateTime();
  if (dt.day.equals(now.day)) {
    return dt.time.toStringMin();
  } else if (dt.day.year == now.day.year) {
    return dt.day.month + "/" + dt.day.day;
  } else {
    return dt.day.year + "/" + dt.day.month + "/" + dt.day.day;
  }
};

const getBody = (post) => {
  /*
  const text = (body) => document.createTextNode(body);
  if (!post.data.translations) return text(post.data.body);
  const tbody = post.data.translations[lang];
  if (!tbody) return text(post.data.body);
  */
  const lang = sellang.value;
  const span = document.createElement("span");
  span.translations = post.data.translations || {};
  span.translations[post.data.lang] = post.data.body;
  span.textContent = span.translations[lang];
  span.className = "text";
  span.lang = post.data.lang;
  return span;
};

const makePost = (post) => {
  const div = document.createElement("div");
  div.className = "post";
  const div2 = document.createElement("div");
  div2.className = "post-content";
  div.appendChild(div2);
  const st = document.createElement("strong");
  st.textContent = post.data.name;
  st.title = post.data.pubkey;
  //st.textContent = post.data.pubkey.substring(0, 4);
  div2.appendChild(st);
  const txt = getBody(post);
  console.log(txt);
  div2.appendChild(txt);
  const dt = document.createElement("span");
  dt.className = "time";
  dt.textContent = time(post.data.id);
  div2.appendChild(dt);
  
  // comments
  const com = document.createElement("div");
  com.className = "comments";
  div.appendChild(com);

  const comments = getComments(post);
  for (const item of comments) {
    const divc = document.createElement("div");
    divc.className = "comment";
    const st = document.createElement("strong");
    st.textContent = item.data.name;
    st.title = item.data.pubkey;
    //st.textContent = item.data.pubkey.substring(0, 4);
    divc.appendChild(st);
    const text = getBody(item);
    divc.appendChild(text);
    const dt = document.createElement("span");
    dt.className = "time";
    dt.textContent = time(item.data.id);
    divc.appendChild(dt);
    com.appendChild(divc);
  }
  // comments form
  const divcs = document.createElement("div");
  divcs.className = "add-comment";
  com.appendChild(divcs);
  const inp = document.createElement("input");
  inp.type = "text";
  inp.className = "text";
  inp.placeholder = "コメント";
  divcs.appendChild(inp);
  const btn = document.createElement("button");
  btn.className = "text";
  btn.textContent = "コメントする";
  divcs.appendChild(btn);
  btn.onclick = async () => {
    btn.disabled = true;
    // post comment
    const body = inp.value;
    if (!body) return;
    const parent = post.data.id;
    showToast(translate("コメントを翻訳中"), 0);
    if (await sendPost(body, parent)) {
      inp.value = "";
      showToast(translate("コメントしました"));
      await show();
    } else {
      showToast(translate("コメントできませんでした"));
    }
    btn.disabled = false;
  };
  return div;
};

btn_post.onclick = async (e) => {
  btn_post.disabled = true;
  const body = ta_body.value;
  if (!body) return;
  showToast(translate("投稿を翻訳中"), 0);
  if (await sendPost(body)) {
    ta_body.value = "";
    showToast(translate("投稿しました"));
    await show();
  } else {
    showToast(translate("投稿できませんでした"));
  }
  e.preventDefault();
  btn_post.disabled = false;
};

/*
btn_sync.onclick = async () => {
  btn_sync.disabled = true;
  await show();
  btn_sync.disabled = false;
};
*/

//const autoupdate = 10 * 1000;
const autoupdate = 60 * 1000; // 1min
setInterval(async () => {
  await show();
}, autoupdate);

await show();

//changeLanguageFromJA("mn");
sellang.value = getLanguage();
changeLanguage(sellang.value);
sellang.oninput = () => {
  changeLanguage(sellang.value);
};

</script>
</body></html>
