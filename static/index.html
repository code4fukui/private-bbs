<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="icon" href="./icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<title>BBS</title>
<!--<link rel="stylesheet" href="style.css">-->
</head><body>

<header><h1 id="title">BBS</h1>
<span id=spanroom></span>
<input type="text" id="in_name" placeholder="名前">
<span id=spannotify>🔔<span id=spannotifyswitch>OFF</span></span>
<span id=spanreload style="padding-left: 1em;">🔃</span>
</header>

<div class="container" id="div_container">
  <div class="post-form">
    <h2>新規投稿</h2>
    <textarea id="ta_body" placeholder="本文をどうぞ！" rows="3" required></textarea>
    <button id="btn_post">投稿する</button>
  </div>

  <div id=posts>
    <!--
  <div class="post">
    <img src="https://via.placeholder.com/600x400" alt="投稿画像">

    <div class="post-content">
      <p><strong>@user1</strong> おいしいランチ！🍱<br>
      おいしいランチ！🍱<br>
      おいしいランチ！🍱<br>
      </p>
    </div>
    <div class="comments">
      <div class="comment"><strong>@commenter</strong> 美味しそう！</div>
      <div class="add-comment">
        <input type="text" placeholder="コメントを書く..."><button>投稿</button>
      </div>
    </div>
  </div>
  -->
  </div>
</div>

<!--
<button id="btn_sync">更新</button>
-->

<footer>
<div><a href=https://github.com/code4fukui/private-bbs/>src on GitHub</a></div>
</footer>

<script>
const cssstyle = localStorage.getItem("cssstyle");
if (cssstyle) {
  document.write(`<link rel="stylesheet" href="${cssstyle}" id="link_csssytle">`);
}
/* // ちらつく
if (cssstyle) {
  const csslink = document.createElement("link");
  csslink.rel = "stylesheet";
  csslink.href = cssstyle;
  csslink.id = "link_csssytle";
  document.head.appendChild(csslink);
}
*/
</script>

<script type="module">
import { TAI64N } from "https://code4fukui.github.io/TAI64N-es/TAI64N.js";
import { Post } from "./Post.js";
import { PubkeyUser, Coder } from "https://code4fukui.github.io/PubkeyUser/PubkeyUser.js";
import { DateTime } from "https://js.sabae.cc/DateTime.js";
import { showToast } from "./showToast.js";
//import { WebPush } from "https://code4fukui.github.io/tsuchichat/static/WebPush.js";
import { WebPush } from "./WebPush.js";
import { makeTextWithLink } from "./makeTextWithLink.js";

const settings = await (await fetch("./settings.json")).json();
document.title = title.textContent = settings.title;
const cssstyle2 = settings.css || "style.css";
localStorage.setItem("cssstyle", cssstyle2);
if (!window["link_csssytle"]) {
  const csslink = document.createElement("link");
  csslink.rel = "stylesheet";
  csslink.href = cssstyle2;
  document.head.appendChild(csslink);
}

let selroom = null;
if (settings.rooms && settings.rooms.length > 0) {
  const sel = document.createElement("select");
  spanroom.appendChild(sel);
  for (const room of settings.rooms) {
    const opt = document.createElement("option");
    opt.textContent = room;
    sel.appendChild(opt);
  }
  selroom = sel;
}
const getRoom = () => {
  return selroom ? selroom.value : undefined;
};

// 記入中本文を自動保存
ta_body.onkeyup = () => {
  localStorage.setItem("ta_body", ta_body.value);
};
const tabody = localStorage.getItem("ta_body");
if (tabody) {
  ta_body.value = tabody;
}
const clearBody = () => {
  localStorage.setItem("ta_body", "");
};

const u = new PubkeyUser();

//
let uuid = WebPush.getID();
spannotifyswitch.textContent = uuid ? "ON" : "OFF";
let spannotifyjob = false;
spannotify.onclick = async () => {
  if (spannotifyjob) return;
  spannotifyjob = true;
  try {
    if (spannotifyswitch.textContent == "OFF") {
      //btnSubscribe.disabled = true;
      //btnSubscribe.textContent = "登録中...";
      showToast("通知の登録中です...", 0);
      uuid = await WebPush.subscribe(u);
      //btnSubscribe.textContent = "登録済み";
      showToast("通知を登録しました")
    } else {
      showToast("通知の解除中です...", 0);
      await WebPush.unsubscribe(u);
      uuid = null;
      showToast("通知を解除しました")
    }
  } catch (e) {
    alert(e);
  }
  spannotifyswitch.textContent = uuid ? "ON" : "OFF";
  spannotifyjob = false;
};
//


let data = [];

let lastdt = null;
let bklist = null;

const show = async () => {
  const res = await u.fetch("getLatest", lastdt);
  for (const item of res) {
    if (!lastdt) {
      lastdt = item.data.id;
    } else {
      if (item.data.id.localeCompare(lastdt) > 0) {
        lastdt = item.data.id;
      }
    }
  }
  res.forEach(i => data.unshift(i));

  const remlist = data.filter(i => i.data.action == "remove").map(i => i.data.parent);

  const list = data.filter(i => !remlist.includes(i.data.id) && !i.data.parent);
  const latest = (item) => {
    let max = item.data.id;
    const chs = data.filter(i => i.data.parent == item.data.id);
    for (const ch of chs) {
      if (max.localeCompare(ch.data.id) < 0) {
        max = ch.data.id;
      }
    }
    return max;
  };
  for (const item of list) {
    item.latest = latest(item);
  }
  list.sort((a, b) => b.latest.localeCompare(a.latest));
  //console.log(list);
  bklist = list;

  reshow();
};

const reshow = async () => {
  const list = bklist;
  if (!list) return;

  const room = getRoom();
  const firstroom = selroom?.selectedIndex == 0;

  posts.innerHTML = "";
  for (const item of list) {
    if (room) {
      if (item.data.room) {
        if (item.data.room != room) continue;
      } else {
        if (!firstroom) continue;
      }
    }
    const div = makePost(item);
    posts.appendChild(div);
  }
};

in_name.value = localStorage.getItem("name") || "";

const sendPost = async (body, parent = null, action = undefined) => {
  const name = in_name.value;
  if (!name) {
    alert("名前をご記入ください");
    return;
  }
  localStorage.setItem("name", name);
  const room = getRoom();

  const id = TAI64N.stringify(TAI64N.encode(new Date()));
  const data = {
    id,
    parent,
    pubkey: u.pubkey,
    name,
    body,
    tags: [],
    uuid,
    room,
    action,
  };
  const post = Post.create(data, Coder.decode(u.prikey));
  try {
    const res = await u.fetch("add", post);
    return res;
  } catch (e) {
    console.log(e);
    alert("通信エラーです。通信状況を確認して再度お試しください");
    return null;
  }
};

if (selroom) {
  selroom.onchange = () => reshow();
}

const getComments = (post) => {
  const com = data.filter(i => post.data.id == i.data.parent);
  com.sort((a, b) => a.data.id.localeCompare(b.data.id));
  const remlist = data.filter(i => i.data.action == "remove").map(i => i.data.parent);
  const com2 = com.filter(i => !remlist.includes(i.data.id));
  return com2;
};

const time = (tai64n) => {
  const dt = new DateTime(TAI64N.toDate(TAI64N.parse(tai64n)));
  const now = new DateTime();
  if (dt.day.equals(now.day)) {
    return dt.time.toStringMin();
  } else if (dt.day.year == now.day.year) {
    return dt.day.month + "/" + dt.day.day;
  } else {
    return dt.day.year + "/" + dt.day.month + "/" + dt.day.day;
  }
};

const makePost = (post) => {
  const div = document.createElement("div");
  div.className = "post";
  const div2 = document.createElement("div");
  div2.className = "post-content";
  div.appendChild(div2);
  const st = document.createElement("strong");
  st.textContent = post.data.name;
  st.title = post.data.pubkey;
  //st.textContent = post.data.pubkey.substring(0, 4);
  div2.appendChild(st);
  const body = document.createElement("span");
  body.innerHTML = makeTextWithLink(post.data.body);
  div2.appendChild(body);
  const dt = document.createElement("span");
  dt.className = "time";
  dt.textContent = time(post.data.id);
  div2.appendChild(dt);
  // remove
  const createRemoveIcon = () => {
    const remspan = document.createElement("span");
    remspan.textContent = "🗑️";
    return remspan;
  };
  if (post.data.pubkey == u.pubkey) {
    const remspan = createRemoveIcon();
    remspan.onclick = async () => {
      if (confirm("この投稿を削除しますか？付いているコメントも非表示になります")) {
        const parent = post.data.id;
        if (await sendPost(null, parent, "remove")) {
          showToast("削除しました");
          await show();
        }
      }
    };
    div2.appendChild(remspan);
  }
  
  // comments
  const com = document.createElement("div");
  com.className = "comments";
  div.appendChild(com);

  const comments = getComments(post);
  for (const item of comments) {
    const divc = document.createElement("div");
    divc.className = "comment";
    const st = document.createElement("strong");
    st.textContent = item.data.name;
    st.title = item.data.pubkey;
    //st.textContent = item.data.pubkey.substring(0, 4);
    divc.appendChild(st);
    const body = document.createElement("span");
    body.innerHTML = makeTextWithLink(item.data.body);
    divc.appendChild(body);
    const dt = document.createElement("span");
    dt.className = "time";
    dt.textContent = time(item.data.id);
    divc.appendChild(dt);

    // remove icon
    if (item.data.pubkey == u.pubkey) {
      const remspan = createRemoveIcon();
      remspan.onclick = async () => {
        if (confirm("このコメントを削除しますか？")) {
          const parent = item.data.id;
          if (await sendPost(null, parent, "remove")) {
            showToast("削除しました");
            await show();
          }
        }
      };
      divc.appendChild(remspan);
    }

    com.appendChild(divc);
  }
  // comments form
  const divcs = document.createElement("div");
  divcs.className = "add-comment";
  com.appendChild(divcs);
  const inp = document.createElement("input");
  inp.type = "text";
  inp.placeholder = "コメントを書く...";
  divcs.appendChild(inp);
  const btn = document.createElement("button");
  btn.textContent = "投稿";
  divcs.appendChild(btn);
  btn.onclick = async () => {
    btn.disabled = true;
    // post comment
    const body = inp.value;
    if (!body) return;
    const parent = post.data.id;
    if (await sendPost(body, parent)) {
      inp.value = "";
      showToast("コメントしました");
      await show();
    }
    btn.disabled = false;
  };
  return div;
};

btn_post.onclick = async (e) => {
  btn_post.disabled = true;
  const body = ta_body.value;
  if (!body) return;
  if (await sendPost(body)) {
    ta_body.value = "";
    clearBody();
    showToast("投稿しました");
    await show();
  }
  e.preventDefault();
  btn_post.disabled = false;
};

/*
btn_sync.onclick = async () => {
  btn_sync.disabled = true;
  await show();
  btn_sync.disabled = false;
};
*/

/*
//const autoupdate = 10 * 1000;
const autoupdate = 60 * 1000; // 1min
setInterval(async () => {
  await show();
}, autoupdate);
*/

await show();

spanreload.onclick = async () => {
  await show();
};
</script>
</body></html>
